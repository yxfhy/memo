# メモ

はい、ご主人さま。
ご主人さまの要件を満たすように、会社のコパイロットにそのまま渡せる仕様プロンプトを用意します。
以下をそのまま貼れば、224固定・ズーム・パン対応のGUIクロップツールを作る指示になります。

──────────────── 要求仕様：印刷スキャン手動クロップツール（224固定・ズーム/パン対応）

目的： 印刷物スキャン画像から、オペレーターが「正常」や「欠陥」などの領域を切り出して保存する。
切り出し領域は必ず 224×224 ピクセル固定。
マウスだけで操作して、現場の人間が簡単にデータを量産できるようにする。

開発条件：

Pythonで作成する単一のGUIツール（1ファイル .py を想定）。

外部ライブラリは標準的なもので良い。優先候補は tkinter + Pillow + OpenCV(cv2) + numpy。

コマンドライン操作ではなくGUI操作前提。

可能な範囲で例外で落ちないようにすること。


機能要件（必須）：

1. 画像読み込み

「画像を開く」ボタンでスキャン画像ファイルをロードする。

ロードした画像をウィンドウ中央のビューに表示する。

画像表示はズーム・パンに対応させること（後述）。

読み込める形式は .png .jpg .jpeg .tif .tiff .bmp 程度。



2. 表示・ズーム・パン

マウスホイール回転でズームイン / ズームアウト。

中クリック（または右ドラッグ、どちらでも良いが明記）で画像表示位置をドラッグしてパン（スクロール移動）できること。

表示はあくまでビュー用のスケール表示でよいが、内部的にはオリジナル解像度座標を常に保持しておくこと。

ズーム倍率とパンのオフセットから、表示上のマウス座標をオリジナル画像内の正確な(x,y)ピクセル座標に逆変換できるようにすること（後のクロップに使う）。



3. 224×224固定のクロップ

左クリックで「クロップ中心」を指定する方式にする。 流れ： a. ユーザーが左クリックした位置（ビュー座標）をオリジナル画像座標に変換する。 b. その座標を中心として、224×224ピクセルの正方形領域を決定する。

左上 = (center_x - 112, center_y - 112)

右下 = (left + 224, top + 224) c. 画像端ではみ出す場合は、はみ出さないように224×224を自動でずらして調整してよい。 （必ず224×224にすること。サイズ変更はしないこと。）


左クリックした瞬間、その224×224領域をクロップ候補として赤い枠でオーバーレイ表示する。

その場で自動保存するのではなく、「保存」ボタンを押すと確定保存する方式にしてほしい。 （誤クリック対策。最後に選んだ枠を保存対象とする。）


追加仕様：

直近で選択中の224枠は画面に半透明の矩形＋枠線で常時表示。

新しく左クリックしたら、その枠を更新する（常に1つだけアクティブな枠）。



4. 保存と出力

出力先フォルダはGUIで指定できるように「出力フォルダ」ボタンを用意すること。ユーザーが任意の場所を選べるようにする。

ラベル入力欄（テキストボックス）を用意すること。 例："normal", "defect" など。これは自由入力でよい。

「保存」ボタンを押すと、現在アクティブな224×224領域をPNGとして保存し、同時にCSVに追記する。


保存仕様：

ファイル名は以下フォーマット： ___xXXXX_yYYYY.png 例: scan001_0007_normal_x0120_y0340.png ここで x,y はクロップ左上座標（オリジナル画像基準ピクセル）。

通し番号はツール起動中でインクリメントしていけばよい（画像をまたいでもリセットしなくていい）。

PNGは224×224固定で保存する。RGB 3ch。


CSV仕様：

同じ出力フォルダに crops_index.csv を作成／追記する。

CSVの列： timestamp, src_image, crop_file, label, x, y, w, h, zoom_at_click, pan_offset

timestamp：保存時刻で良い

src_image：元画像ファイル名

crop_file：保存したPNGファイル名

label：GUIのラベル欄の文字列

x,y：クロップ左上座標（オリジナル画像基準）

w,h：必ず224,224

zoom_at_click：そのクロップを指定した時のズーム倍率

pan_offset：その時点の表示オフセット（デバッグ/再現用）


ヘッダ行はファイルが無い場合のみ書く。存在する場合は追記だけ。



5. プレビュー

「保存」ボタンで保存した直後、その224×224のクロップ画像を右側の小さなプレビュー領域に表示する。

プレビューは最後に保存した1枚だけでよい。



6. エラーハンドリング / バリデーション

出力フォルダが未指定のまま「保存」ボタンを押した場合はダイアログで警告し、処理しない。

画像がロードされていない状態や、224枠がまだ選ばれていない状態で「保存」ボタンを押した場合も同様に警告。

224枠が画像外へ完全に出てしまうケースはないよう、クリック時点で自動補正すること。



7. コード構造

mainウィンドウ生成部

画像表示用Canvasまたは類似ウィジェット

ズーム・パンの状態管理（zoom_scale, pan_x, pan_y）

マウスイベントコールバック

左クリック：クロップ枠更新

ホイール：ズーム倍率更新＋再描画

中ボタンドラッグ（もしくは右ドラッグ）：pan_x, pan_y更新＋再描画


現在アクティブなクロップ枠(224×224)をCanvas上にオーバーレイ描画する関数

「保存」ボタン押下時の処理関数

オリジナル画像から224×224領域を切り出してPNG保存

CSV追記

プレビュー更新

通し番号インクリメント




8. 前提・禁止事項

自動リサイズなどで224以外のサイズを保存してはいけない。

224×224より小さい領域は保存しない。必ず224×224。

オリジナル画像を変形・補間したものを保存しない。必ずオリジナル解像度からそのまま切り出した生ピクセルを保存すること。

表示はどれだけ縮小・拡大しても良いが、保存とCSVに記録する x,y 座標は必ずオリジナル解像度基準の整数ピクセル座標であること。



9. 想定ワークフロー

ツール起動

出力フォルダを指定

「画像を開く」で1枚読み込み

ズームとパンで見たい場所まで寄る

欲しい箇所を左クリック → 224枠が赤く出る

ラベル欄に "normal" など入力

「保存」ボタン → PNG＋CSV記録 → プレビュー更新

別の箇所を左クリックして繰り返し

次の画像を「画像を開く」でロードして続行




優先度の高い項目（実装で必ず守ること）：

1. 224×224固定クロップ


2. マウスホイールズーム


3. ドラッグパン


4. クリックでクロップ位置決定＋「保存」でPNG+CSV


5. CSVに座標とラベルが残ること ────────────────



ご主人さまへの補足： ・224固定にしているので、学習側／メモリバンク側の前処理がブレません。
・ズーム＋パンは現場で小さなドット欠けを見る時に必須なので、仕様で最初から強制します。
・「クリックした瞬間に保存」ではなく「保存ボタンで確定」にしているのは、誤クリック事故を避けるためです。

作成日時: 2025-10-28 10:09:20