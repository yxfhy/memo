# メモ

はい、ご主人さま。了解しました。ご主人さまが欲しいのは「画面に1枚ドンと表示 → マウスでドラッグして矩形選択 → その矩形をPNGで保存 → 座標も記録する」タイプの手動切り出しツールです。
会社のコパイロットに渡す仕様書としてそのままコピペできる形を用意します。

──────────────── 要求仕様（GUI版タイル切り出しツール）

目的： 印刷物スキャン画像を表示し、オペレーターがマウスで欠陥っぽい箇所や正常箇所を矩形ドラッグで切り出して保存できるようにする。
後工程で異常検出モデル用データセット（normal_bank / defect例など）を作るために使う。

環境：

Python製スタンドアロンツールで作ってほしい

依存は OpenCV(cv2) と tkinter のどちらでも良いが、マウスドラッグで矩形を描けてPNG保存できればOK

可能なら1ファイルの .py で完結してほしい


基本フロー：

1. ユーザーが画像ファイル（スキャン画像）を開く


2. 画像がアプリウィンドウにフルで表示される


3. ユーザーがマウス左ドラッグで矩形を描く


4. ドラッグを離した瞬間、その矩形をクロップして自動で保存


5. 同時に、その矩形のメタ情報をCSVに追記


6. ユーザーは同じ画像で何回でも矩形を切り出せる


7. 次の画像を開いて続けられる



画面UI要素：

メイン画像ビュー（ドラッグで矩形指定できるキャンバス）

右か上あたりに簡単なパネル

「画像を開く」ボタン（ファイルダイアログ）

「出力先フォルダ」ボタン（フォルダダイアログ）

「ラベル」入力欄（テキストボックス）

例: "normal" / "defect" などをオペレーターが手で入力

保存ファイル名とCSVに入れる


「終了」ボタン



マウス操作仕様：

左クリック押下開始時点を(x1,y1)、ドラッグ中は画面上に半透明の矩形ガイドを表示してほしい

左ボタンを離した時点の座標を(x2,y2)として、(minx,miny,width,height)を計算

widthまたはheightが小さすぎる（例えば10px未満）の場合は無視して保存しないでよい

有効なら即クロップ処理に進む


クロップ保存仕様：

切り出した領域をRGBのままPNGで保存

ファイル名は以下フォーマットにする： ___xXXXX_yYYYY_wWWWW_hHHHH.png 例: scan001_0007_normal_x0120_y0340_w0224_h0224.png 連番は、そのセッション中でインクリメントすれば良い（画像またいでも通し番号でOK）


CSVログ仕様：

ツール実行ディレクトリ直下、もしくは出力フォルダ直下に crop_index.csv を作る/追記する

1行1クロップ

列は以下：

timestamp （保存時刻でいい）

src_image （元画像ファイル名）

crop_file （保存したPNGファイル名）

label （GUIのラベル入力欄の内容）

x y w h （元画像上の座標と幅高さ、ピクセル）


CSVが存在しない場合はヘッダ行をつけて新規作成、存在する場合は末尾に追記


拡大・確認機能：

クロップ保存したあと、別の小ウィンドウか右側の領域に「今保存したタイルのプレビュー」を一瞬表示してほしい（確認用）

プレビューは直近1つだけでいい。履歴全表示までは不要


ラベル運用：

ラベルは自由文字列で良い

目的は後で normal_bank 用と defect例用を分けられるようにすること

現段階ではラベルによって保存先フォルダを変える必要はない（全部同じフォルダでOK）


その他の要件：

画像表示はリサイズしてもいいが、座標は必ず「元画像のフル解像度の座標」で記録してほしい
（つまり表示用に縮小しても、記録とクロップはオリジナル座標・オリジナル画素で行うこと）

画像切り替え時は現在の連番カウンタはリセットしなくていい。連番はツール起動中ずっとユニークで進んでいけば十分

例外で落ちないように、最小限の例外ハンドリング（ファイルが保存できない時はエラーダイアログ）


想定ワークフロー：

1. ツール起動


2. 「出力先フォルダ」を指定


3. 「画像を開く」でスキャン画像を表示


4. ラベル欄に"normal"と入力


5. きれいなベタ領域をドラッグ → 離す → 自動保存＋CSV追記


6. ラベル欄を"defect"に変える


7. 欠陥っぽいところをドラッグ → 保存


8. 次のスキャン画像を「画像を開く」で読み替えて続行



優先度：

1. マウスドラッグで矩形を指定できること


2. 座標つきでクロップPNGを自動保存できること


3. CSVログを残せること


4. GUIとして現場の人が使えること（コマンドを叩かせないこと）



この仕様でPythonツールを作成してください。 ────────────────

ご主人さま向けの補足：

・このGUIツールは「半自動アノテーション器」みたいな立ち位置になる。
・これで集めたnormalタイル群をnormal_bankに、defectタイル群を評価・閾値決め用に流せるようになる。
・つまりライン導入前の教師データづくりとしきい値設計が、人力で回しやすくなる。

作成日時: 2025-10-28 09:42:59