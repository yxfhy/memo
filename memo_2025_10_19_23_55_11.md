# メモ

はい、ご主人さま。scipy.signal.find_peaks の実装フローを、ソースに基づいて「どの段階で“鞍点（谷底）”＝baseを決めるか」を中心に順を追ってまとめます。

0) 入口と“局所極大”の定義

入力配列から**局所極大（peak）**をまず抽出します。定義は「両隣より大きいサンプル」で、**平頂（plateau）**の場合は中央インデックス（偶数幅なら切り下げ）を採用します。これは find_peaks の Notes と内部ヘルパ _local_maxima_1d の仕様に対応しています。 


1) 条件フィルタの評価順

抽出した候補ピークに対して、条件は固定順序で適用されます：
plateau_size → height → threshold → distance → prominence → width（高速なものを先に当てて削減）。

2) distance（ピーク間隔）の処理

「最小サンプル間隔」を満たすまで近接ピークを間引きます。これは Cython 実装 _select_by_peak_distance が担い、与えた**優先度（通常は高さなど）**に基づいて残すピークを決めます。find_peaks の説明にも「条件を満たすまで小さい方を消す」旨が明記されています。 


3) ★ 鞍点（base）の決定＝prominence 計算段階

鞍点（base）は prominence を計算するときに初めて確定します。アルゴリズムは以下のとおり：

1. 対象ピークの高さから水平線を左右に伸ばし、（a）評価窓の端（wlen で制限可）に当たる、または（b）より高いピークの斜面に再交差するまで進める（同じ高さのピークでの交差は無視）。


2. その左右の評価区間で最小値となる位置が left_base / right_base（＝谷底＝鞍点）。


3. 2つの base のうち高い方が最低等高線となり、そこからの垂直距離が prominence。
以上が SciPy の公式手順です。wlen を狭めると真の全域的等高線より高い局所的等高線になり、prominence が小さめに出ます（意図的に“局所 prominence”を計る用途）。



例示として、同高さピークは境界に使わない・より高いピークが境界を与えるという挙動がドキュメントの具体例にも示されています。


> まとめると、鞍点は prominence 計算の第2ステップで決まり、結果は left_bases, right_bases として返ります（prominence を要求したとき）。



4) width（幅）の計算と鞍点との関係

width は prominence と連動します。まず評価高さを

で決定し、この高さの水平線と波形の交点を左右で求め（線形補間）、それらの差を幅とします（left_ips, right_ips, widths を返す）。rel_height=1.0 なら最低等高線での幅、0.5 なら**半高さ（FWHMに相当）**です。
※ここで用いる prominence は前段（=鞍点確定済み）で得たものです。


5) 返り値とプロパティの出力条件

height や threshold, prominence, width, plateau_size を指定した場合のみ、対応する中間結果が properties に入ります。具体的には prominences / left_bases / right_bases、widths / width_heights / left_ips / right_ips、平頂の plateau_sizes / left_edges / right_edges など。



---

要点の総括

“鞍点（base）”は find_peaks の最初期ではなく**、prominence を評価する段階で明示的に決定されます（left_base と right_base）。

その後の width は、その prominence（＝鞍点から規定される最低等高線）を使って評価高さを作り、交点から幅を求めます。

条件の適用順は固定で、distance → prominence → width の順に進むため、鞍点確定は distance 処理の後です。


ご所望でしたら、特定の信号に対して left_bases/right_bases・left_ips/right_ips がどう動くかを可視化する簡潔なデモも作れます。



作成日時: 2025-10-20 08:55:09