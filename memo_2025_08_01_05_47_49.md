# メモ

ご主人さま、お待たせいたしました。
WSL 2 の Ubuntu 環境に「Docker Engine（無償の CLI 版）」と NVIDIA Container Toolkit を導入し、CUDA 11 系／12 系など複数バージョンのイメージを切り替えて使うまでの手順をまとめました。必要な作業は Windows 側の準備 → Ubuntu 側の設定 → Docker 本体の導入 → GPU 連携の有効化 → 動作確認 の順で進めるのが確実でございます。


---

1 . Windows 側の前提確認

1. NVIDIA ドライバ

2021 年以降の「CUDA on WSL 2 対応ドライバ」（バージョン 465 以降）が入っていることを nvidia-smi.exe でご確認ください。



2. WSL 2 & Ubuntu

wsl --list --verbose でディストリビューションが Version 2 になっていれば問題ございません。





---

2 . WSL 2 (Ubuntu) 側で systemd を有効化（推奨）

sudo tee /etc/wsl.conf https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# ご主人さまのユーザを docker グループへ
sudo usermod -aG docker $USER
newgrp docker   # このセッションに反映

systemd を有効化した場合は

sudo systemctl enable --now docker

無効化のままの場合は、ログイン時に service docker start を呼ぶワンライナーを .profile などに仕込む方法が紹介されています。


---

4 . NVIDIA Container Toolkit を導入して GPU 連携を有効化

# リポジトリキーとリストを追加
curl -fsSL https://nvidia.github.io/libnvidia-container/gpgkey | \
  sudo gpg --dearmor -o /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg

curl -s -L https://nvidia.github.io/libnvidia-container/stable/deb/nvidia-container-toolkit.list | \
  sed 's#deb https://#deb [signed-by=/usr/share/keyrings/nvidia-container-toolkit-keyring.gpg] https://#g' | \
  sudo tee /etc/apt/sources.list.d/nvidia-container-toolkit.list

sudo apt-get update
sudo apt-get install -y nvidia-container-toolkit

インストール後、公式ツールで Docker ランタイムを nvidia 対応に切り替えます。

sudo nvidia-ctk runtime configure --runtime=docker
sudo systemctl restart docker
```2

---

### 5 . 動作確認  
```bash
# CUDA 12 系の公式ベースイメージで GPU をテスト
docker run --rm --gpus all nvidia/cuda:12.4.1-base-ubuntu22.04 nvidia-smi

GPU 情報が表示されれば連携成功でございます。CUDA 11 系を試す場合はタグを 11.8.0-base-ubuntu22.04 などに置き換えてください。


---

6 . 複数 CUDA バージョンの使い分け

Docker では ホスト側の CUDA ランタイムに依存せず、イメージごとに必要なバージョンを切り替えられます。
例：

# CUDA 11 系
docker run --rm --gpus all nvidia/cuda:11.8.0-devel-ubuntu22.04 nvcc --version

# CUDA 12 系
docker run --rm --gpus all nvidia/cuda:12.4.1-devel-ubuntu22.04 nvcc --version

プロジェクトごとに docker-compose.yml を作成し、サービス単位で image: を変えると管理が容易でございます。ランタイム指定は Compose v2 なら deploy: resources: reservations: devices: でも、従来の runtime: nvidia オプションでも動作します。


---

参考

Docker Engine/Linux 公式スクリプト導入手順と WSL2 自動起動例

NVIDIA Container Toolkit のリポジトリ登録～インストール手順

nvidia-ctk runtime configure による Docker ランタイム切替とテスト例


以上でございます。これでご主人さまの WSL 2 環境でも Docker を用いた CUDA バージョン切替 が自在に行えます。ご不明点があれば、いつでもお申し付けくださいませ。



作成日時: 2025-08-01 14:47:42