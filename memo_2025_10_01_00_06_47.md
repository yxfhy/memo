# メモ

Stable Diffusion XL とデータ拡張の概要

近年、Stable Diffusion XL（SDXL）などの高品質な拡散型生成モデルが登場し、データ拡張手法として注目を集めている。これらのモデルは自然言語プロンプトから高解像度の画像を生成できるため、少数の実画像から多様な合成画像を作り出し、視覚認識モデルの学習に利用できる。特に画像セグメンテーションや異常検出などのタスクでは、マスク（領域）やテキスト条件付けを併用した拡散モデルにより、既存データの構造を保ちつつ新たな画像を生成する研究が多数報告されている。たとえば、医療画像セグメンテーションではSDXLのような潜在拡散モデルを用い、テキストで病変を説明して正常画像にパッチ的に病変を埋め込むことで、稀な病変パターンを合成しデータ拡張する手法（SynDiff, DiffAug）が実践されている。

生成モデルによる合成データ生成 – テキストプロンプトや画像マスクを条件に用い、拡散モデル（潜在拡散モデル）で新規画像を生成する。生成画像はセグメンテーションや分類ネットワークの学習にそのまま用いることができる。

テキスト・マスク条件付き拡散 – 例えば「銅の傷」や「墨跡の紙上パターン」などの自然言語をプロンプトに用い、欠陥やインク模様を指定領域に生成する。SDXLのインペインティング機能を利用し、元画像の一部を保持しつつ指定領域のみを生成・変形する手法が効果的である。

制御拡散モデル – ControlNetやセグメンテーションマスクを入力とする手法で、元画像の構造を厳密に保持しながらスタイルや背景を変更できる。たとえば、衛星画像や合成画像の背景を変えたり、オブジェクトのスタイルをドメイン間で転送したりする応用例がある。

事前学習モデル利用 – Stable Diffusionの学習済みモデルを特徴抽出器や事前分布として用いる例も出ている。例えば、画像品質評価ではStable DiffusionのU-Net部分から特徴を取り出し品質スコア推定器に利用することで、従来手法より高い汎化性能を示す成果が報告されている。


セグメンテーションタスクへの応用

セグメンテーション問題では、ラベル付きデータの作成コストが高いため、拡散モデルによる合成が有効に働く事例が増えている。たとえば、医学画像セグメンテーションの分野では、内視鏡ポリープや網膜病変などの希少な異常領域を生成して学習データを補強する方法が提案されている。SynDiffと呼ばれる手法では、医療画像に対し「不規則な表面のポリープ」などの臨床記述を用いてSDXLで新規ポリープ画像を合成し、生成画像と実画像の両方でセグメンテーションモデルを訓練することで、精度向上が確認されている。さらに、制御拡散モデルを用いた研究では、クラス・プロンプトやエッジ情報を組み合わせ、元画像のセグメンテーションマスク内でのみ生成を行うことで、ラベル構造を保持したまま多様な背景やスタイル変換を実現している。

分野横断的な例 – 衛星画像や工業画像でも同様のアプローチが採用されている。例えば都市の衛星画像で車両を含む画像から背景のみを変える衛星物体検出用データ拡張や、低解像度空撮画像を高解像度化しつつ樹木セグメンテーションの精度を50％以上向上させる手法などが報告されている。

マスクインペインティング – セグメンテーションマスク領域を保持し、マスク外の領域を生成することでアノテーションを付け替え可能。Stable Diffusionのin-paintingを利用し、対象物の位置を固定したまま背景や周辺の新規パターンを生成する手法が有効である。

LoRA等による微調整 – LoRAなどの軽量ファインチューニングで、特定の微細パターン（例：医療病変や微小な欠陥）を短時間で学習し、特定領域にリアルな変化を埋め込む研究も進んでいる。たとえば「DefectFill」では少量の欠陥画像・マスク対を用いてインペインティングモデルを微調整し、正常画像に多様な欠陥を自然に埋め込むことで検査タスクを強化している。


欠陥検出タスクへの応用

製造業や印刷業界では表面欠陥検出が重要課題だが、実世界では欠陥画像が稀少であるため、拡散モデルを用いた合成画像でこれを補う研究が進む。ExDDのような手法では、産業ドメインに即したテキスト条件付きの潜在拡散モデルによりリアルな欠陥画像を生成し、正常群と欠陥群の分布を別々にモデル化することで異常検出性能を高めている。具体的には「金属の引っかき傷」や「ガラス上の白斑」などといったプロンプトで合成し、生成された画像を訓練データに加えて異常検出モデルを訓練することで、高い検出精度を達成している。

パッチ単位の異常合成 – 拡散モデルを用いて小さな欠陥パターンのみを合成することで、大判画像中の欠陥領域を増強する。たとえばLDAMやDefectFillの研究では、欠陥部位のマスクを用いてその部分だけ拡散モデルで塗りつぶすことで、局所的な欠陥イメージを大量合成する。

ドメイン適合プロンプト – 「銅板のサビ」や「プラスチック表面のクラック」など、対象ドメインに合ったプロンプトを用いて、インダストリアルな文脈を保った合成画像を生成することで、モデルのコンテキスト依存性を損なわない工夫が行われている。

実世界アプリケーション – 印刷物や半導体製造では、印刷ずれやインク飛び、回路欠陥などを検出するのに類似手法が期待できる。実際、車道の亀裂検出（RoadFusion）やガラス欠陥生成（Glass Defect】、鉄鋼表面の欠陥拡張（DefectDiffusion）など多様な研究が報告されている。


画像品質評価タスクへの応用

カメラで撮影した印刷物の品質評価（Document IQA）でも、拡散モデルやその事前学習機構を活用した研究が注目されている。例えば、汎用画像の品質評価であるDP-IQAでは、事前学習済みのStable Diffusionを背骨（バックボーン）に用い、拡散U-Netの特徴を抽出してノイズやぼけの有無を推定することで、従来比で高い一般化性能が得られている。これは「拡散モデルの持つ強い画像認識能力を品質スコア推定に転用する」アプローチであり、印刷物画像でも同様に利用可能である。加えて、ドキュメント画像品質評価（DIQA）では、スマホ撮影で生じるぼけや傾きなどを手動歪み指標で評価する研究も古くからあり、新たに拡散モデルを使って意図的に劣化画像を生成・学習させることで、OCR性能予測モデルなどを強化する可能性が期待されている。

拡散事前モデルの利用 – Stable DiffusionのU-Net部分を特徴抽出器とし、テキストエンコーダの出力を品質評価の入力とすることで、少量データでも頑健な画像品質推定モデルを構築できる。

教師なし品質評価との併用 – 従来のDIQAではシャープネス指標や学習済み特徴による手法が用いられてきたが、生成モデルで多様な劣化パターン（ぼけ、ノイズ、露出不足など）を合成し、それを教師データにすることで回帰モデルの訓練を行う研究も考えられる。


劣化付加・スタイル転送による拡張手法

通常画像に意図的な劣化や他スタイルを付加してモデルを頑健化する手法も、拡散モデルの出番である。テキスト条件付きモデルでは「雨天」「夜間」「古書風」などのプロンプトを用いて画像全体の雰囲気を一括変換でき、StyleGANやCycleGANと比較して多様なスタイルを生成できる。特にクラス条件付けやセマンティックガイド付きの手法（CACTIなど）では、意味的境界を保ちながら領域ごとに異なるスタイルを適用し、合成ドメイン（シミュレーション）→実世界のドメイン適応に効果を上げている。スタイル転送の産業応用例としては、飛行機画像の認識タスクで夜間・悪天候下の画像への転送を試みた研究がある。一方で、Stable Diffusionは元々高品質生成を志向しているため、意図的に「低品質」な劣化を再現するのは難しく、ノイズやコントラスト低下を加えたスタイル画像を参考に生成する工夫が必要である。

スタイル転送（拡散モデル） – クラス・領域ごとにAdaptive Instance Normalization や注意機構を用い、元画像の内容を保ちながらターゲットドメインの色調・質感を付与する。たとえば都市道路のシミュレーション画像を実写風にする研究などがあり、従来技術より忠実な構造維持が報告されている。

ノイズ・劣化合成 – 生成モデルに条件付けを工夫し、カメラノイズ・ブラー・露出ずれなどの劣化を画像全体または選択的領域に付加する。Stable Diffusionのテキストプロンプトで劣化語（例：「ぼやけた」「ざらざらした」）を使ったり、劣化サンプルを条件としてControlNetを使う方法が研究されている。O’Sheaらは「低品質スタイル画像」を参照条件として安定拡散を用いたが、通常は高品質画像を生成するため、明示的な制御（Conditioning）が必要であると指摘している。


実装例・オープンソース

これらの手法は多くの場合、公開ライブラリやフレームワークを活用して実装できる。Hugging Face の diffusers ライブラリや、ControlNet、Stable Diffusion inpainting pipeline などを利用すれば、手元のデータセットに対して容易に拡散モデルによる加工を行える。また、LoRAやDreamBoothで拡散モデルを微調整し、ドメイン固有の概念（欠陥の形状や特定スタイル）を学習させる事例も増えている。たとえばDefectFillやExDDの著者らは、少量のラベル付き欠陥データでStable Diffusion inpaintingモデルをLoRA調整し、リアルな欠陥画像を自動生成するワークフローを公開している。これにより、従来必要だった大量の撮影・アノテーション作業を大幅に削減できる可能性がある。

また、産業用途の実例としては、半導体パネルや印刷ラインでの欠陥検査装置に拡散モデルを組み込む研究、あるいは紙面印刷物の品質検査に生成モデルによる「意図的欠陥付加」を行う開発案件などが進行中である。例えばOLEDパネルの欠陥検出用データ取得システムでは、画像合成を介した不足データの補充が検討されている（権利関係で全文閲覧は制限されているが内容としてはSDXL類似技術の応用が想定される）。

参考文献

拡散モデルによる画像生成とデータ拡張の総論

医療画像セグメンテーションにおけるSDXL拡張手法（SynDiff, DiffAug）

産業欠陥検出と拡散モデル（ExDD, DefectFill）

画像品質評価への拡散モデル適用（DP-IQA）

拡散モデルによるスタイル転送とドメイン適応




作成日時: 2025-10-01 08:51:03