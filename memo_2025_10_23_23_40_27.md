# メモ

#!/usr/bin/env bash
set -euo pipefail

TARGET_VER="3.13.9"
MAJMIN="3.13"

# 1) Windows Python Launcher 必須（公式インストーラー既定で入っています）
if ! command -v py >/dev/null 2>&1; then
  echo "ERROR: 'py' ランチャーが見つかりません。公式インストーラーで入れてください。"
  exit 1
fi

# 2) 既存 3.13 の実体パスを取得（例: C:\Users\…\Python313\python.exe）
LINE=$(py -0p | tr -d '\r' | grep -E '3\.13' | head -n 1 || true)
if [ -z "$LINE" ]; then
  echo "ERROR: 既存の 3.13 系が見つかりません。"
  exit 1
fi
PY_EXE=$(echo "$LINE" | grep -Eo '[A-Z]:\\.*python\.exe$' || true)
if [ -z "$PY_EXE" ]; then
  echo "ERROR: python.exe の場所を解釈できません。"
  exit 1
fi
TARGET_DIR=$(echo "$PY_EXE" | sed 's#\\python\.exe$##')

# 3) 全社インストールか判定（Program Files なら InstallAllUsers=1）
if echo "$TARGET_DIR" | grep -qi 'Program Files'; then
  INSTALL_ALL=1
else
  INSTALL_ALL=0
fi

# 4) CPU アーキ判定して 3.13.9 の正確な公式 EXE を取得
ARCH="${PROCESSOR_ARCHITEW6432:-${PROCESSOR_ARCHITECTURE:-AMD64}}"
if echo "$ARCH" | grep -qi '64'; then
  PKG="python-${TARGET_VER}-amd64.exe"
else
  PKG="python-${TARGET_VER}.exe"
fi
URL="https://www.python.org/ftp/python/${TARGET_VER}/${PKG}"

TMPDIR=$(mktemp -d)
trap 'rm -rf "$TMPDIR"' EXIT
cd "$TMPDIR"
curl -L -f -o "$PKG" "$URL"

# 5) サイレント上書き（同一 TargetDir を明示 → 3.13.9 に“だけ”更新）
"./$PKG" /quiet \
  TargetDir="$TARGET_DIR" \
  InstallAllUsers="$INSTALL_ALL" \
  PrependPath=1 Include_test=0 Include_pip=1 Include_launcher=1

# 6) 検証（py ランチャーで 3.13 の実バージョン確認）
NEW=$(py -3.13 -c "import sys; print('.'.join(map(str, sys.version_info[:3])))" 2>/dev/null || true)
if [ "$NEW" != "$TARGET_VER" ]; then
  echo "ERROR: アップグレード確認失敗。現在: $NEW / 期待: $TARGET_VER"
  exit 1
fi

echo "OK: Python ${MAJMIN} を ${TARGET_VER} へ上書き更新しました（場所: ${TARGET_DIR}）。"

# （任意）pip ツール群を静かに更新（失敗しても続行）
py -3.13 -m pip --version >/dev/null 2>&1 && \
py -3.13 -m pip install --upgrade pip setuptools wheel -q || true

作成日時: 2025-10-24 08:40:24