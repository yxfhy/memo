# 拡散モデル応用物体検出技術DiffusionDet

DiffusionDetの技術的アーキテクチャ

図1: DiffusionDetの全体フレームワーク。(左) 画像エンコーダが入力画像から特徴を抽出し、(右) 検出デコーダが入力候補ボックスを順次洗練して最終的なボックスとラベルを出力する。

画像エンコーダ: 入力画像から高次元特徴マップを抽出するモジュールで、ResNetやSwin Transformerなどが用いられる。抽出した特徴はFPN（Feature Pyramid Network）でマルチスケール表現に変換する。このエンコーダは一度だけ実行され、以降の拡散プロセス全体で条件として機能する。

検出デコーダ: Sparse R-CNNに類似し、候補ボックスからRoIAlignで特徴を切り出し、検出ヘッドでボックス回帰・クラス分類を行うモジュール。DiffusionDetでは学習時に正解ボックスにノイズを加えた候補ボックスを、推論時にはガウス分布からサンプリングしたランダムボックスを入力とする。

6段階カスケードヘッド: 検出デコーダは6段階のカスケード構造から成り、各段階で候補ボックスを逐次修正していく。ただし、一般的なCascade R-CNNとは異なり、各段階は同一パラメータ（シェア重み）で再利用される点が特徴である。また、各ステップにタイムスタンプ埋め込みを付加し、拡散過程の進行度をモデルに知らせる（反復評価）ことで、同じデコーダヘッドを繰り返し適用できる。

拡散モデルの適用: DiffusionDetでは、座標空間で拡散モデルを適用するため、データ点としてボックス(center_x, center_y, w, h) の集合を扱う。すなわち、通常のDDPMで画像にノイズを加えるように、本手法では正解ボックスにガウスノイズを加えてノイズボックスを生成する。そして検出デコーダはノイズを除去（元のボックス予測）するように学習される。


学習方法および推論プロセス

学習ステージ: まず画像内の全ての正解ボックス集合を固定数$N_{\rm train}$にパディングする。既存のボックスを複製するか、無作為なボックスで埋める手法を用い、固定長に揃える。次に各ボックスに対しコサインスケジュールに従った強度でガウスノイズを加え、ノイズ付きボックス集合$\tilde{b}$を得る。このとき、信号強度のスケーリングも工夫しており、物体検出では画像生成より大きめの信号比が好まれるという報告がある。得られたノイズ付きボックス$\tilde{b}$を検出デコーダに入力し、元の正解ボックスを復元するよう学習する。損失はセット予測ロス（Hungarianマッチングによる分類＋回帰の組み合わせ）で定義され、複数の出力ボックスから正解への最適対応を求める。

推論（サンプリング）プロセス: まず画像をエンコードし、$N_{\rm eval}$個のランダムボックス（ガウス分布からサンプリング）を初期候補とする。次に指定したステップ数だけ、以下の拡散逆プロセスを繰り返す: ① 現在のボックス集合を検出デコーダに入力し、元の（正解に近い）ボックスを予測する。② 得られた予測結果を用いてDDIM法で次ステップのボックスを推定する。③ 低スコアの「誤検出」と考えられるボックスを除去し、同数の新たなランダムボックスで補充する（ボックス更新）。これにより、学習時のノイズ分布に近い状態を保ちながら反復的にボックスを改善できる。最後に十分に改善されたボックスが検出結果となる。なお、学習時の候補数$N_{\rm train}$と推論時の候補数$N_{\rm eval}$は独立に設定可能であり、推論時により多くのボックスや繰り返し回数を用いることで精度向上が見込める。


歴史的背景と技術進化の流れ

従来の物体検出手法: 2010年代前半のR-CNN系（R-CNN→Fast R-CNN→Faster R-CNN）では、まず領域提案（Region Proposal）を生成し、それぞれを分類・回帰する二段階構造が主流だった。一方、YOLOシリーズやRetinaNetなどの一段階検出器では、グリッドごとに複数のアンカーボックスに対し直接クラスと位置を回帰する手法が提案され、極めて高速な推論を実現した（ただし小物体の検出精度はやや劣る傾向があった）。

トランスフォーマーによる検出: 2020年にCarionらが提案したDETRでは、学習可能な「クエリ」を用いるエンコーダ・デコーダ構造で、全体をセット予測問題としてエンドツーエンドに解いた。従来のNMSや手工芸的な領域設計を不要とし、Faster R-CNNと同等の精度を達成した。その後、DETRの弱点であった学習の遅さや空間解像度不足を改善するため、Deformable DETR（局所的なサンプリング点への注意機構）やDAB-DETR、DN-DETRなどの改良が次々と提案された。さらにクエリ固定のSparse R-CNNやDINOなども登場し、クエリベース検出の研究が活発化した。

拡散モデルの台頭: 一方、2015年頃から拡散モデル（Diffusion Model）は進化し、特に2020年のDDPM（Denoising Diffusion Probabilistic Models）で高品質な画像生成が可能となった。その後、Stable Diffusionのような潜在空間での拡散モデルや、音声・テキストへの応用も相次ぎ、画像セグメンテーションへの拡散モデル利用例も現れた。しかし、拡散モデルを物体検出に応用する試みはこれまで報告がなく、領域予測問題と拡散の組み合わせは未開拓領域だった。DiffusionDet（2022年末提案）は、こうした流れの中で「ノイズからボックスへ」の検出パラダイムを初めて実現したものである。


既存手法との比較

性能比較（COCO Val, ResNet-50）: DiffusionDetは複数の評価ボックス数・ステップで性能を変化させられる点が特徴であり、例えば1ステップ・300ボックスでは45.8 APを達成する（ResNet-50）。表1に示すように、この値はFaster R-CNN (40.2 AP) やDETR (42.0 AP) を上回り、Sparse R-CNN (45.0 AP) と同等水準である。またステップ数・ボックス数を増やすとさらに性能向上し、最大で約47 APまで伸びる。

手法	バックボーン	COCO Val AP	COCO Val AP50	COCO Val AP75

Faster R-CNN	R50	40.2	61.0	43.8
DETR	R50	42.0	62.4	44.2
Deformable DETR	R50	43.8	62.6	47.7
Sparse R-CNN	R50	45.0	63.4	48.2
DiffusionDet (1 step,300)	R50	45.8	64.1	50.4
DiffusionDet (4 steps,300)	R50	46.6	65.1	51.3


長所と短所:

DiffusionDet: 学習・推論で扱うボックス数を柔軟に変えられる（訓練時300→推論時500など）。また何度もデコーダを再利用して段階的に精度を高められる反復評価が可能で、高い精度が得られる。一方、拡散サンプリングの反復処理により推論コストが高く、遅延が大きい。最新の手法（DETR系の大型モデルや最新YOLO）と比べると絶対精度では若干劣る場合があるが、ボックス候補のデザインが極めてシンプルで拡張性が高い点が特徴。

DETR系: DETR自体はエンドツーエンドで構造が簡潔だが、トレーニングには膨大な学習ステップを要する。Deformable DETRやDINOではこれを改善し、高速収束・小物体検出性向上を実現した。一般にこれらはAttentionが中心のため計算コストが高めである。

YOLO系: YOLOでは1つのCNNでボックスを回帰することで超高速推論を実現している。例えば原論文のモデルは約45 FPS、軽量モデルは155 FPSを達成した。ただし高速化の代償として、小物体の位置精度は他手法より劣る傾向がある。最新のYOLOv7ではCOCOで56.8% APを記録するなど（30FPS以上のリアルタイム検出器で最高精度）。

Faster R-CNN系: 領域提案ネットワーク（RPN）により優れた初期候補を得て、高い精度を実現する。ただし二段階構造ゆえに推論速度は数FPS程度に留まる。Cascade R-CNNなどではさらに段階的精練を導入し、難検出物体の精度を上げている。

その他（Sparse R-CNN等）: Sparse R-CNNは学習可能な固定ボックスを使い6段構成で精度を出し、DiffusionDetと同程度の性能を持つ。


拡散モデル一般とDiffusionDetの関係性

拡散モデル（DDPM）は、データに徐々にガウスノイズを加える順方向過程$q(z_t|z_0)$と、学習したモデル$f_\theta$でノイズを除去して元データ$z_0$を復元する逆方向過程$p_\theta(z_{t-1}|z_t)$からなる。DiffusionDetではこのアイデアを位置空間に適用し、ボックス位置の座標集合を対象とする生成モデルとして検出を定式化している。すなわち、学習時に正解ボックスにノイズを付加したノイズボックスから元のボックスを推定するよう学習し、推論時にランダムボックスから正解ボックスを逐次生成する。DiffusionDetではサンプリング加速手法のDDIMを採用しており、推論中に予測結果とDDIMステップで次のボックスを推定する。一方で、拡散モデル全般に共通する欠点として、サンプリングに多くの反復が必要で推論速度が遅い傾向がある点が挙げられる。Stable Diffusionのような画像生成向け拡散モデル（テキスト条件付き潜在拡散モデル）とは異なり、DiffusionDetはあくまで画像の領域検出を行うための拡散モデルである。

現在の評価や研究動向

ベンチマーク評価: COCOやLVISのベンチマークでDiffusionDetは良好な成績を示す。例えばResNet-50モデルではCOCO valで45.8 AP（1ステップ・300ボックス）を達成し、ResNet-101版で47 AP以上に到達する。また、ボックス数や反復回数を増やすとさらに数ポイント向上することが報告されている。LVISやその他の長尾データセットでも、DiffusionDetはSparse R-CNNなど既存法と同等の性能を示している（詳細はTable3参照）。

クロスドメイン・ゼロショット: 学習済みモデルを別分布に適用する性能も注目される。DiffusionDetは推論時のボックス数やステップ数を増やせる性質を活かし、COCO学習モデルをCrowdHumanデータセットへ直接適用した際に、従来法より大幅にAPを改善できることが示されている。表1(a)(b)より、推論時にボックス数とステップ数を増加させると、それぞれ最大+5.3 APの向上が得られた。

拡散検出器の派生研究: DiffusionDetの発表以降、拡散モデルを活用した物体検出の応用研究が増えている。例として、OrfaigらはRGBカメラとLiDAR深度情報を融合したRGB-D DiffusionDetを提案し、自動運転用途でKITTIデータセットの自動車検出精度を2.3ポイント改善した。また、Heらは拡散生成モデルをドメイン適応に用いる枠組み（Diffusion Domain Teacher, DDT）を提案し、複数のクロスドメイン検出ベンチマークで平均21.2%のmAP改善を報告している。さらに、Open-world検出（未知クラスの検出）への拡張や、マルチモーダル検出への応用研究（例：RGB+赤外線融合検出）なども注目されている。

今後の展望: 拡散モデルの性能向上や高速化技術が進むにつれ、DiffusionDet自身もさらなる改良が可能と考えられる。例えば、Deformable Attentionやより大規模なバックボーンを組み合わせることで、DINOなど最先端モデルに迫る精度が期待されると論文でも指摘されている。また、他の拡散手法（例：条件拡散、Score-basedモデル）との融合や、拡散過程に学習的成分を導入する試みなど、研究動向は活発である。


参考資料: DiffusionDet論文、DETR論文、Deformable DETR論文、YOLO原論文、Faster R-CNN論文、関連研究など。



作成日時: 2025-07-02 09:39:14